<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <link rel="manifest" href="site.webmanifest">

  <link rel="apple-touch-icon" href="icon.png">
  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/music-notation-font.css">
  <link rel="stylesheet" href="css/font-awesome/all.css">
  <link rel="stylesheet" href="css/musicsheet.css">
  <link rel="stylesheet" href="css/main.css">

  <meta name="theme-color" content="#fafafa">
  <script src="js/vendor/modernizr-3.11.2.min.js"></script>
  <script src="js/vendor/bootstrap.bundle.min.js"></script>
  <script src="js/vendor/font-awesome-all.min.js"></script>
  <script src="js/vendor/vexflow.js"></script>
</head>

<body>

<div class="container">
  <div class="row">

    <div class="mb-3" id="musicsheet_settings">
      <div class="card card-body">
        <h5 class="card-title">Musicsheet Settings: </h5>
        <div class="row">
          <div class="col-2">
            <label class="form-label" for="clef">Clef:</label>
            <select class="form-select" aria-label="Clef" id="clef" onchange="updateMusicSheetSetting()">
              <option value="treble" seleted>Treble</option>
              <option value="bass">Bass</option>
              <option value="alto">Alto</option>
              <option value="tenor">Tenor</option>
              <option value="percussion">Percussion</option>
            </select>
          </div>
          <div class="col-2">
            <label class="form-label" for="key_sig">Key : </label>
            <select class="form-select" id="key_sig" onchange="updateMusicSheetSetting()">
              <option value="C" selected>C/Am</option>
              <option value="G">G/Em</option>
              <option value="D">D/Bm</option>
              <option value="A">A/F#m</option>
              <option value="E">E/C#m</option>
              <option value="B">B/G#m</option>
              <option value="F#">F#/D#m</option>
              <option value="Db">Db/Bbm</option>
              <option value="Ab">Ab/Fm</option>
              <option value="Eb">Eb/Cm</option>
              <option value="Bb">Bb/Gm</option>
              <option value="F">F/Dm</option>
            </select>
          </div>
          <div class="col-2">
            <label class="form-label" for="beats_per_measure">Beats :</label>
            <input class="form-control" id="beats_per_measure" type="number" value="4" placeholder="Beats per measure"
                   onchange="updateMusicSheetSetting()">
          </div>
          <div class="col-2">
            <label class="form-label" for="beats_value">Beat Value :</label>
            <select class="form-select" id="beats_value" onchange="updateMusicSheetSetting()">
              <option>1</option>
              <option>2</option>
              <option selected>4</option>
              <option>8</option>
              <option>16</option>
            </select>

          </div>
          <div class="col-2">
            <label class="form-label" for="bpm">Bpm:</label>
            <input class="form-control" id="bpm" type="number" value="120" placeholder="Beats per minute">
          </div>
        </div>
      </div>
    </div>
    <div class="" id="note_settings">
      <div class="card card-body">
        <h5 class="card-title">Note Settings:</h5>
        <div class="row note-setting-row">
          <div>
            <label class="form-label" for="note_name">Note:</label>
            <select class="form-select" id="note_name">
              <option value="A" selected>A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="E">E</option>
              <option value="F">F</option>
              <option value="G">G</option>
            </select>
          </div>
          <div>
            <label class="form-label">Accidental:</label>
            <div class="btn-group accidental" role="group" aria-label="Accidental">
              <input class="btn-check" type="radio" name="accidental" id="acc_flat" autocomplete="off" value="b">
              <label class="btn btn-outline-secondary" for="acc_flat">
                <span class="icon-flat"></span>
              </label>
              <input class="btn-check" type="radio" name="accidental" id="acc_natural" autocomplete="off" value="">
              <label class="btn btn-outline-secondary" for="acc_natural">
                <span class="icon-natural"></span>
              </label>
              <input class="btn-check" type="radio" name="accidental" id="acc_sharp" autocomplete="off" value="#">
              <label class="btn btn-outline-secondary" for="acc_sharp">
                <span class="icon-sharp"></span>
              </label>
            </div>
          </div>
          <div>
            <label class="form-label">Octave:</label>
            <select class="form-select" id="octave">
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4" selected>4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </div>
          <div>
            <label class="form-label">Duration:</label>
            <div class="notes-group-wrapper">
              <div class="notes-group">
                <div class="d-note-wrapper">
                  <span class="d-note icon-whole-note" draggable="true" ondragend="measureOnDragEnd(event, 'w')"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-half-note" draggable="true" ondragend="measureOnDragEnd(event, 'h')"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-quarter-note" draggable="true" ondragend="measureOnDragEnd(event, 4)"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-8th-note" draggable="true" ondragend="measureOnDragEnd(event, 8)"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-16th-note" draggable="true" ondragend="measureOnDragEnd(event, 16)"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-32th-note" draggable="true" ondragend="measureOnDragEnd(event, 32)"></span>
                </div>
              </div>
              <button class="btn btn-outline-secondary dot" type="button" id="dot_note" data-bs-toggle="button">
                <i class="fa-solid fa-circle fa-2xs"></i>
              </button>
            </div>
          </div>
          <div>
            <label class="form-label">Rest note:</label>
            <div class="notes-group-wrapper">
              <div class="notes-group">
                <div class="d-note-wrapper">
                  <span class="d-note icon-whole-rest" draggable="true"
                        ondragend="measureOnDragEnd(event, 'wr')"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-half-rest" draggable="true" ondragend="measureOnDragEnd(event, 'hr')"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-quarter-rest" draggable="true"
                        ondragend="measureOnDragEnd(event, 'qr')"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-8th-rest" draggable="true" ondragend="measureOnDragEnd(event, '8r')"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-16th-rest" draggable="true"
                        ondragend="measureOnDragEnd(event, '16r')"></span>
                </div>
                <div class="d-note-wrapper">
                  <span class="d-note icon-32th-rest" draggable="true"
                        ondragend="measureOnDragEnd(event, '32r')"></span>
                </div>
              </div>
              <button class="btn btn-outline-secondary dot" type="button" id="dot_rest" data-bs-toggle="button">
                <i class="fa-solid fa-circle fa-2xs"></i>
              </button>
            </div>
          </div>
        </div>
        <div>
          <button class="btn btn-secondary" type="button" onclick="addNewMeasure()">Add Measure</button>
          <button class="btn btn-secondary" type="button" onclick="addToNote()">Add to Note</button>
          <button class="btn btn-secondary" type="button" onclick="deleteNote()">Delete note</button>
        </div>

      </div>
    </div>
  </div>
  <div id="output" draggable="true">
    <div></div>
  </div>
</div>
<script src="./js/main.js"></script>
<script src="./js/measure.js"></script>
<script src="./js/musicsheet/musicsheet1.js"></script>

<script>
  var MS = new MusicSheet();
  var currentMeasure = false;
  var currentNote = false;
  var dropCondition = false;
  var duration = false;
  var clickedNote = false;

  function noteOnClick(measureId, noteId) {
    let noteClicked = document.getElementById("vf-" + measureId + "_" + noteId);
    if (noteClicked.classList.contains("highlighted")) {
      noteClicked.classList.remove('highlighted');
      clickedNote = false;
    } else {
      clickedNote = {measureId, noteId};
      Array.from(document.getElementsByClassName("highlighted")).forEach(function (el) {
        el.classList.remove('highlighted');
      });
      document.getElementById("vf-" + measureId + "_" + noteId).classList.add("highlighted");
    }
  }

  function noteOnDragOver(event, measureId, noteId) {
    currentMeasure = measureId;
    currentNote = noteId;
    // noteDragOver = document.getElementById("vf-" + measureId + "_" + noteId).classList.add('dragging');
    event.preventDefault();
  }

  function noteOnDragLeave(event, measureId, noteId) {
    // noteDragOver = document.getElementById("vf-" + measureId + "_" + noteId).classList.remove('dragging');
    event.preventDefault();
  }

  function measureOnDragOver(event, measureId) {
    console.log("measureOnDragOver");
    currentMeasure = measureId;
    const parentElement = document.getElementById("vf-stave_" + measureId);
    const parentRect = parentElement.getBoundingClientRect();
    const childrenIdSelector = '[id^=vf-' + measureId + "]";
    const children = Array.from(document.querySelectorAll(childrenIdSelector));
    let notePrev = false;
    let noteNext = false;
    for (let i = 0; i < children.length; i++) {
      if (i === 0 && isOnLeft(event, measureId, i)) {
        currentNote = 0;
        notePrev = i;
        dropCondition = "isOnLeft";
        break;
      } else if (i === children.length - 1 && isOnRight(event, measureId, i)) {
        currentNote = i;
        notePrev = i;
        dropCondition = "isOnRight";
        break;
      } else if (isInBetween(event, measureId, i, i + 1)) {
        currentNote = i;
        notePrev = i;
        noteNext = i + 1;
        dropCondition = "isInBetween";
        break;
      }
    }
    removeAllDraggingClassFromNotes();
    children.forEach((child, index) => {
      if (index == notePrev || index == noteNext) {
        child.classList.add("dragging");
      } else {
        child.classList.remove("dragging");
      }
    })

    event.preventDefault();
  }

  function measureOnDragLeave(event, measureId) {
    console.log("measureOnDragLeave");
    currentMeasure = false;
    currentNote = false;
    dropCondition = false;
    removeAllDraggingClassFromNotes(currentMeasure);
    event.preventDefault();
  }

  function measureOnDragEnd(event, duration) {
    let noteName = document.getElementById('note_name').value;
    noteName = (noteName.slice(-1) === "r") ? "b" : noteName;
    const octave = document.getElementById('octave').value;
    const dot = (noteName.length > 1) ? document.getElementById('dot_rest').classList.contains("active") : document.getElementById('dot_note').classList.contains("active");

    switch (dropCondition) {
      case "isInBetween":
        MS.addNoteToMeasure(currentMeasure, {noteName, octave, duration, dot}, currentNote + 1)
        break;
      case "isOnLeft" :
        MS.addNoteToMeasure(currentMeasure, {noteName, octave, duration, dot}, currentNote)
        break;
      case "isOnRight":
        MS.addNoteToMeasure(currentMeasure, {noteName, octave, duration, dot})
        break;
      default:
        currentMeasure = false;
        currentNote = false;
        dropCondition = false;
        break;
    }
    MS.render();

    clickedNote = false;
  }


  function removeAllDraggingClassFromNotes(measureId = false) {
    let noteArray = [];
    if (measureId !== false) {
      const childrenIdSelector = '[id^=vf-' + measureId + "]";
      noteArray = Array.from(document.querySelectorAll(childrenIdSelector));
    } else {
      noteArray = Array.from(document.querySelectorAll(".vf-stavenote"));
    }
    noteArray.forEach((el) => {
      el.classList.remove("dragging");
    });
  }

  function isInBetween(event, measureId, nodeId1, nodeId2) {
    const measure = document.getElementById("vf-stave_" + measureId);
    const note1 = document.getElementById("vf-" + measureId + "_" + nodeId1);
    const note2 = document.getElementById("vf-" + measureId + "_" + nodeId2);

    const mouseX = event.clientX;
    const note1Rect = note1.getBoundingClientRect();
    if (measure && note1 && note2) {
      const note2Rect = note2.getBoundingClientRect();
      return mouseX > note1Rect.right && mouseX < note2Rect.left;
    } else {
      return false;
    }
  }

  function isOnLeft(event, measureId, nodeId) {
    const measure = document.getElementById("vf-stave_" + measureId);
    const note = document.getElementById("vf-" + measureId + "_" + nodeId);

    const mouseX = event.clientX;
    const noteRect = note.getBoundingClientRect();
    if (measure && note) {
      return mouseX < noteRect.left;
    } else {
      return false;
    }
  }

  function isOnRight(event, measureId, nodeId) {
    const measure = document.getElementById("vf-stave_" + measureId);
    const note = document.getElementById("vf-" + measureId + "_" + nodeId);

    const mouseX = event.clientX;
    const noteRect = note.getBoundingClientRect();
    if (measure && note) {
      return mouseX > noteRect.right;
    } else {
      return false;
    }
  }

  function addNewMeasure() {
    MS.addMeasure();
    MS.render();
  }

  function addToNote() {
    let noteName = document.getElementById('note_name').value;
    const octave = document.getElementById('octave').value;
    const dot = document.getElementById('dot_note').classList.contains("active");

    if (clickedNote && noteName.slice(-1) !== "r") {
      MS.addNoteToMeasure(clickedNote.measureId, {noteName, octave, duration, dot}, currentNote, false);
      clickedNote = false;
    }
  }

  function deleteNote() {
    if (clickedNote) {
      MS.deleteNoteFromMeasure(clickedNote.measureId, clickedNote.noteId);
      MS.render();
    }
  }

  function updateMusicSheetSetting() {
    console.log("updateMusicSheetSetting");
    const keySignature = document.getElementById("key_sig").value;
    MS.updateMusicSheetSetting({
      clef: document.getElementById("clef").value,
      beatsPerMeasure: document.getElementById("beats_per_measure").value,
      beatValue: document.getElementById("beats_value").value,
      bpm: document.getElementById("bpm").value,
      keySignature: document.getElementById("key_sig").value
    });
    MS.render();

  }

  (async function () {

    MS.setMusicSheet(musicSheetJson);
    MS.addMeasure();
    MS.addNoteToMeasure(2, {noteName: "E", octave: 4, duration: 4});
    MS.addNoteToMeasure(2, {noteName: "A", octave: 4, duration: 4, dot: true}, 0)
    MS.render();

    console.log(MS.getMusicSheetJson());


  })();

</script>
</body>

</html>
